name: Release Snag

on:
  push:
    tags:
      - "v*"

jobs:
  publish-mac:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest"

      - name: Build App
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Update Info.plist version strings from tag
          PLIST="mac/Snag/Info.plist"
          plutil -replace CFBundleShortVersionString -string "$VERSION" "$PLIST"
          plutil -replace CFBundleVersion -string "$VERSION" "$PLIST"

          # Now build the app
          xcodebuild -project mac/Snag.xcodeproj \
                     -scheme Snag \
                     -configuration Release \
                     -derivedDataPath Build/ \
                     ARCHS="arm64 x86_64" \
                     ONLY_ACTIVE_ARCH=NO \
                     BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
                     SUPPORTS_MACCATALYST=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY=""

          # Ad-hoc sign the app (crucial for Sparkle/Gatekeeper on modern macOS)
          codesign --force --deep --sign - Build/Build/Products/Release/Snag.app

      - name: Package App
        run: |
          mkdir -p dist/publish
          cp -R Build/Build/Products/Release/Snag.app dist/
          # Create zip in the publish folder
          ditto -c -k --sequesterRsrc --keepParent dist/Snag.app dist/publish/Snag.zip

      - name: Sign and Generate AppCast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          if [ -z "$SPARKLE_PRIVATE_KEY" ]; then
            echo "::error::SPARKLE_PRIVATE_KEY secret is not set or empty!"
            exit 1
          fi

          # Use mktemp for private key
          KEY_FILE=$(mktemp)
          # Ensure no trailing newlines or spaces (robustness for copy-paste)
          printf "%s" "$SPARKLE_PRIVATE_KEY" | tr -d '\n\r ' > "$KEY_FILE"
          chmod 600 "$KEY_FILE"

          # Diagnostic: Check key length
          KEY_LEN=$(wc -c < "$KEY_FILE")
          echo "Private key file created. Length: $KEY_LEN bytes"

          # Download and extract Sparkle tools
          curl -sL -o sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz
          tar -xf sparkle.tar.xz bin/generate_appcast

          # Use generate_appcast to create/update AppCast.xml based on the publish folder
          # Adding --verbose to see more details if it fails
          ./bin/generate_appcast \
            --verbose \
            --ed-key-file "$KEY_FILE" \
            --download-url-prefix "https://github.com/thanhcuong1990/Snag/releases/download/v${VERSION}/" \
            --link "https://github.com/thanhcuong1990/Snag/releases/tag/v${VERSION}" \
            -o AppCast.xml \
            dist/publish/

          echo "AppCast.xml generated successfully"

          # Cleanup
          rm -f "$KEY_FILE" sparkle.tar.xz
          rm -rf bin

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/publish/Snag.zip
            AppCast.xml
          body: "New release ${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit Updated AppCast
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Save the generated AppCast.xml before switching branches
          cp AppCast.xml /tmp/AppCast.xml

          # Fetch and checkout main branch (workflow runs on tag, not main)
          git fetch origin main
          git checkout main

          # Restore the generated AppCast.xml
          cp /tmp/AppCast.xml AppCast.xml

          git add AppCast.xml
          git commit -m "chore: update AppCast.xml for ${{ github.ref_name }}"
          git push origin main

  publish-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Update version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating Android version to $VERSION"
          sed -i "s/coordinates(\"io.github.thanhcuong1990\", \"snag\", \"[^\"]*\")/coordinates(\"io.github.thanhcuong1990\", \"snag\", \"$VERSION\")/" android/snag/build.gradle.kts
          cat android/snag/build.gradle.kts | grep coordinates

      - name: Publish to Maven Central
        run: |
          cd android
          ./gradlew :snag:publishAllPublicationsToMavenCentralRepository
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          # Key ID is often optional if the key itself is provided, but good to have if needed by your gradle setup
          # ORG_GRADLE_PROJECT_signingKeyId: ${{ secrets.SIGNING_KEY_ID }}

  publish-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating iOS podspec version to $VERSION"
          sed -i '' "s/s.version *= *'[^']*'/s.version          = '$VERSION'/" Snag.podspec
          cat Snag.podspec | grep "s.version"

      - name: Deploy to CocoaPods
        run: |
          set -eo pipefail
          pod trunk push Snag.podspec --allow-warnings
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
