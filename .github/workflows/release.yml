name: Release Snag

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest"

      - name: Build App
        run: |
          # Build a universal binary (Apple Silicon + Intel)
          xcodebuild -project mac/Snag.xcodeproj \
                     -scheme Snag \
                     -configuration Release \
                     -derivedDataPath Build/ \
                     ARCHS="arm64 x86_64" \
                     ONLY_ACTIVE_ARCH=NO \
                     BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
                     SUPPORTS_MACCATALYST=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY=""

      - name: Package App
        run: |
          mkdir -p dist/publish
          cp -R Build/Build/Products/Release/Snag.app dist/
          # Create zip in the publish folder
          ditto -c -k --sequesterRsrc --keepParent dist/Snag.app dist/publish/Snag.zip

      - name: Sign and Generate AppCast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          if [ -z "$SPARKLE_PRIVATE_KEY" ]; then
            echo "::error::SPARKLE_PRIVATE_KEY secret is not set or empty!"
            exit 1
          fi

          # Use mktemp for private key
          KEY_FILE=$(mktemp)
          # Ensure no trailing newlines or spaces (robustness for copy-paste)
          printf "%s" "$SPARKLE_PRIVATE_KEY" | tr -d '\n\r ' > "$KEY_FILE"
          chmod 600 "$KEY_FILE"

          # Diagnostic: Check key length
          KEY_LEN=$(wc -c < "$KEY_FILE")
          echo "Private key file created. Length: $KEY_LEN bytes"

          # Download and extract Sparkle tools
          curl -sL -o sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz
          tar -xf sparkle.tar.xz bin/generate_appcast

          # Use generate_appcast to create/update AppCast.xml based on the publish folder
          # Adding --verbose to see more details if it fails
          ./bin/generate_appcast \
            --verbose \
            --ed-key-file "$KEY_FILE" \
            --download-url-prefix "https://github.com/thanhcuong1990/Snag/releases/download/v${VERSION}/" \
            --link "https://github.com/thanhcuong1990/Snag/releases/tag/v${VERSION}" \
            -o AppCast.xml \
            dist/publish/

          echo "AppCast.xml generated successfully"

          # Cleanup
          rm -f "$KEY_FILE" sparkle.tar.xz
          rm -rf bin

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/publish/Snag.zip
            AppCast.xml
          body: "New release v${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit Updated AppCast
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add AppCast.xml || true
          git commit -m "chore: update AppCast.xml for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin main || echo "Failed to push AppCast change"
