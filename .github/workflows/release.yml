name: Release Snag

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest"

      - name: Build App
        run: |
          # Build a universal binary (Apple Silicon + Intel)
          xcodebuild -project mac/Snag.xcodeproj \
                     -scheme Snag \
                     -configuration Release \
                     -derivedDataPath Build/ \
                     ARCHS="arm64 x86_64" \
                     ONLY_ACTIVE_ARCH=NO \
                     BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
                     SUPPORTS_MACCATALYST=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY=""

      - name: Package App
        run: |
          mkdir -p dist
          # The binary is usually at Build/Build/Products/Release/Snag.app
          cp -R Build/Build/Products/Release/Snag.app dist/
          cd dist
          zip -ry Snag.zip Snag.app

      - name: Sign Update
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Verify the zip exists
          if [ ! -f "dist/Snag.zip" ]; then
            echo "::error::dist/Snag.zip not found!"
            ls -R dist/
            exit 1
          fi

          # Create the private key file safely
          printf "%s" "$SPARKLE_PRIVATE_KEY" > ed25519_private_key.pem

          # Download Sparkle tools
          curl -L -o sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz

          # Find and extract sign_update (avoiding .dSYM files)
          SIGN_UPDATE_IN_ARCHIVE=$(tar -tf sparkle.tar.xz | grep -v "\.dSYM" | grep "/sign_update$" | head -n 1)
          if [ -z "$SIGN_UPDATE_IN_ARCHIVE" ]; then
            # Try without leading slash just in case
            SIGN_UPDATE_IN_ARCHIVE=$(tar -tf sparkle.tar.xz | grep -v "\.dSYM" | grep "^sign_update$" | head -n 1)
          fi

          if [ -z "$SIGN_UPDATE_IN_ARCHIVE" ]; then
            echo "::error::Could not find sign_update binary in sparkle.tar.xz"
            exit 1
          fi

          echo "Extracting $SIGN_UPDATE_IN_ARCHIVE"
          tar -xf sparkle.tar.xz "$SIGN_UPDATE_IN_ARCHIVE"
          chmod +x "$SIGN_UPDATE_IN_ARCHIVE"

          # Sign the zip
          # Capture stdout for signature, stderr goes to runner log
          SIGNATURE=$("./$SIGN_UPDATE_IN_ARCHIVE" dist/Snag.zip -p ed25519_private_key.pem)

          if [ -z "$SIGNATURE" ]; then
            echo "::error::Failed to generate signature (Empty output)"
            exit 1
          fi

          echo "SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
          echo "Generated Signature: $SIGNATURE"

          # Cleanup
          rm ed25519_private_key.pem

      - name: Update AppCast.xml
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")

          # Update AppCast.xml with new version, signature, and date
          # We use | as a delimiter for sed to avoid issues with / in URLs
          sed -i '' "s|sparkle:version=\"[^\"]*\"|sparkle:version=\"$VERSION\"|g" AppCast.xml
          sed -i '' "s|sparkle:shortVersionString=\"[^\"]*\"|sparkle:shortVersionString=\"$VERSION\"|g" AppCast.xml
          sed -i '' "s|sparkle:edSignature=\"[^\"]*\"|sparkle:edSignature=\"$SIGNATURE\"|g" AppCast.xml
          sed -i '' "s|<pubDate>[^<]*</pubDate>|<pubDate>$DATE</pubDate>|g" AppCast.xml

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/Snag.zip
            AppCast.xml
          body: "New release v${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit Updated AppCast
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add AppCast.xml
          git commit -m "chore: update AppCast.xml for ${{ github.ref_name }}"
          git push origin main
